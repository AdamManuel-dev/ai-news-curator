name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Validate PR title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          test
          chore
          perf
        scopes: |
          api
          auth
          cache
          config
          container
          discovery
          health
          middleware
          ranking
          scraper
          tagging
          vector
          
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check for breaking changes
      run: |
        # Run tests to ensure no regressions
        npm run test
        
        # Check if public API interfaces have changed
        if git diff --name-only HEAD~1 | grep -E "(src/types|src/interfaces)" > /dev/null; then
          echo "⚠️  Public API changes detected - ensure backward compatibility"
          echo "breaking_changes=true" >> $GITHUB_ENV
        fi
        
    - name: Comment on PR if breaking changes
      if: env.breaking_changes == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '⚠️ **Breaking Changes Detected**\n\nThis PR appears to modify public API interfaces. Please:\n\n1. Update the CHANGELOG.md\n2. Bump the major version if needed\n3. Add migration guide if necessary\n4. Ensure all tests pass'
          })

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Analyze bundle size
      run: |
        # Get build size
        BUILD_SIZE=$(du -sh dist/ | cut -f1)
        echo "Build size: $BUILD_SIZE"
        
        # Store for comparison
        echo "build_size=$BUILD_SIZE" >> $GITHUB_ENV
        
    - name: Comment bundle size
      uses: actions/github-script@v7
      with:
        script: |
          const buildSize = process.env.build_size;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `📦 **Bundle Size Report**\n\nBuild size: ${buildSize}\n\n_Generated by GitHub Actions_`
          })